name: Random Proxy Test

on:
  workflow_dispatch:

jobs:
  run-proxy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install sing-box + subscribe tool
      run: |
        curl -L -o singbox.tar.gz \
          https://github.com/SagerNet/sing-box/releases/download/v1.12.14/sing-box-1.12.14-linux-amd64.tar.gz
        tar -xzf singbox.tar.gz
        sudo mv sing-box-1.12.14-linux-amd64/sing-box /usr/local/bin/sing-box
        sudo mv sing-box-1.12.14-linux-amd64/sing-box-subscribe /usr/local/bin/sing-box-subscribe
        sudo chmod +x /usr/local/bin/sing-box /usr/local/bin/sing-box-subscribe

    - name: Download proxy list
      run: |
        curl -L -o proxies.txt \
        https://raw.githubusercontent.com/ebrasha/free-v2ray-public-list/refs/heads/main/all_extracted_configs.txt

    - name: Extract random proxy
      run: |
        grep -Eo '(vmess|vless|ss|trojan|hy2)://[^ ]+' proxies.txt | shuf -n 1 > random_proxy.txt
        echo "Random proxy:"
        cat random_proxy.txt

    - name: Convert proxy using sing-box-subscribe
      run: |
        sing-box-subscribe url "$(cat random_proxy.txt)" > config.json
        echo "Generated config.json:"
        cat config.json

    - name: Start sing-box proxy
      run: |
        sing-box run -c config.json &
        sleep 5

    - name: Print IP through proxy
      run: |
        echo "IP through proxy:"
        curl --socks5 127.0.0.1:1080 https://api.ipify.org
