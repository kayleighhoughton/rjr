name: Random Proxy Test (V2Ray)

on:
  workflow_dispatch:

jobs:
  run-proxy:
    runs-on: ubuntu-latest

    steps:
    - name: Install V2Ray
      run: |
        sudo bash <(curl -L https://raw.githubusercontent.com/v2fly/fhs-install-v2ray/master/install-release.sh)

    - name: Download proxy list
      run: |
        curl -L -o proxies.txt \
        https://raw.githubusercontent.com/ebrasha/free-v2ray-public-list/refs/heads/main/all_extracted_configs.txt

    - name: Extract random proxy
      run: |
        grep -Eo '(vmess|vless|ss|trojan)://[^ ]+' proxies.txt | shuf -n 1 > random_proxy.txt
        echo "Random proxy:"
        cat random_proxy.txt

    - name: Convert proxy to V2Ray config
      run: |
        v2ray convert -f random_proxy.txt -o config.json
        echo "Generated config.json:"
        cat config.json

    - name: Start V2Ray proxy
      run: |
        sudo v2ray run -c config.json &
        sleep 5

    - name: Print IP through proxy
      run: |
        echo "IP through proxy:"
        curl --socks5 127.0.0.1:1080 https://api.ipify.org
