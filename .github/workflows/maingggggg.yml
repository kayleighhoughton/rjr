name: Test Public Proxies

on:
  workflow_dispatch:
  schedule:
    - cron: '0 6 * * *'

jobs:
  test-proxies:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install sing-box
        run: |
          wget -O sing-box.tar.gz https://github.com/SagerNet/sing-box/releases/download/v1.12.14/sing-box-1.12.14-linux-amd64.tar.gz
          tar xzf sing-box.tar.gz
          sudo mv sing-box-1.12.14-linux-amd64/sing-box /usr/local/bin/sing-box
          sudo chmod +x /usr/local/bin/sing-box

      - name: Download proxy list and extract proxies
        run: |
          curl -L 'https://raw.githubusercontent.com/ebrasha/free-v2ray-public-list/refs/heads/main/all_extracted_configs.txt' -o proxies.txt
          grep -E '^(ss://|ssr://|trojan://|vless://|vmess://)' proxies.txt > all_proxies.txt

      - name: Test each proxy with sing-box
        run: |
          cat << 'EOF' > test_proxy.sh
          #!/bin/bash
          url="$1"
          port=$((RANDOM%1000+10080))

          if [[ $url == ssr://* ]]; then
            echo "Skipping SSR proxy (not supported by sing-box): $url"
            exit 0
          fi

          TMPDIR=$(mktemp -d)
          CONFIG_FILE="$TMPDIR/config.json"
          LOG_FILE="$TMPDIR/singbox.log"

          # Use sing-box built-in converter to get correct outbound config JSON
          OUTBOUND_JSON="$(/usr/local/bin/sing-box api convert --target json "$url" 2>/dev/null)"
          if [ -z "$OUTBOUND_JSON" ]; then
            echo "[FAILED] Unable to convert URL to outbound: $url"
            rm -rf "$TMPDIR"
            exit 1
          fi

          cat > "$CONFIG_FILE" <<CONFIG
          {
            "log": {"level": "warn", "output": null},
            "inbounds": [{
              "type": "socks",
              "tag": "socks-in",
              "listen": "127.0.0.1",
              "listen_port": $port
            }],
            "outbounds": [
              $OUTBOUND_JSON
            ],
            "route": {
              "rules": [{
                "type": "field",
                "inbound_tag": ["socks-in"],
                "outbound_tag": "proxy"
              }]
            }
          }
          CONFIG

          /usr/local/bin/sing-box run -c "$CONFIG_FILE" > "$LOG_FILE" 2>&1 &
          PID=$!

          # Wait up to 10 seconds for SOCKS to be up
          for i in {1..10}; do nc -z 127.0.0.1 $port && break; sleep 1; done

          curl --socks5-hostname 127.0.0.1:$port --max-time 10 https://github.com/ -I >/dev/null 2>&1
          CURL_STATUS=$?

          if kill -0 $PID 2>/dev/null; then kill $PID; fi
          wait $PID 2>/dev/null

          if [ $CURL_STATUS -eq 0 ]; then
            echo "[OK] $url"
            rm -rf "$TMPDIR"
            exit 0
          else
            echo "[FAILED] $url"
            cat "$LOG_FILE"
            rm -rf "$TMPDIR"
            exit 1
          fi
          EOF
          chmod +x test_proxy.sh

          for proto in ss:// ssr:// trojan:// vless:// vmess://; do
            proto_short="${proto//[:\/]/}"
            grep "^$proto" all_proxies.txt | head -n 2 > "$proto_short.txt"
          done

          err_count=0

          for proto in ss ssr trojan vless vmess; do
            while read -r url; do
              [ -z "$url" ] && continue
              echo "==== Testing $url ===="
              ./test_proxy.sh "$url" || err_count=$((err_count+1))
            done < "$proto.txt"
          done

          if [ $err_count -ne 0 ]; then
            echo "Some proxies failed to connect."
            exit 1
          else
            echo "All tested proxies successful or skipped."
          fi
