name: Random Proxy Test

on:
  workflow_dispatch: 

jobs:
  run-proxy: 
    runs-on:  ubuntu-latest

    steps: 
    - name:  Checkout
      uses: actions/checkout@v4

    - name: Install sing-box
      run: |
        set -e
        VERSION=$(curl -s https://api.github.com/repos/SagerNet/sing-box/releases/latest | grep -oP '"tag_name"\s*:\s*"\K[^"]+')
        echo "Latest version:  $VERSION"
        
        curl -L --fail -o singbox.tar.gz \
          "https://github.com/SagerNet/sing-box/releases/download/${VERSION}/sing-box-${VERSION}-linux-amd64.tar.gz"
        
        # Extract and find the binary
        tar -tzf singbox. tar.gz
        tar -xzf singbox.tar.gz
        
        # Find the sing-box binary
        SING_BOX=$(find . -maxdepth 2 -name "sing-box" -type f 2>/dev/null | head -1)
        if [ -z "$SING_BOX" ]; then
          echo "Error:  sing-box binary not found in archive"
          exit 1
        fi
        
        sudo mv "$SING_BOX" /usr/local/bin/sing-box
        sudo chmod +x /usr/local/bin/sing-box
        sing-box --version

    - name: Download proxy list
      run: |
        curl -L -o proxies.txt \
          https://raw.githubusercontent.com/ebrasha/free-v2ray-public-list/refs/heads/main/all_extracted_configs. txt

    - name: Extract random proxy
      run: |
        grep -Eo '(vmess|vless|ss|trojan|hy2)://[^ ]+' proxies.txt | shuf -n 1 > random_proxy.txt
        echo "Random proxy:"
        cat random_proxy.txt

    - name: Convert proxy to sing-box config
      run: |
        sing-box generate -u "$(cat random_proxy.txt)" > config.json
        echo "Generated config. json:"
        cat config.json

    - name: Start sing-box proxy
      run: |
        sing-box run -c config.json &
        PROXY_PID=$! 
        sleep 5
        if !  kill -0 $PROXY_PID 2>/dev/null; then
          echo "Error:  sing-box failed to start"
          exit 1
        fi

    - name: Print IP through proxy
      run: |
        echo "IP through proxy:"
        curl --socks5 127.0.0.1:1080 https://api.ipify.org || echo "Proxy connection failed"
