name: Random Proxy Test

on:
  workflow_dispatch:

jobs:
  run-proxy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install sing-box
      run: |
        VERSION=$(curl -s https://api.github.com/repos/SagerNet/sing-box/releases/latest | grep tag_name | cut -d '"' -f 4)
        echo "Latest version: $VERSION"
        curl -L -o singbox.tar.gz \
          https://github.com/SagerNet/sing-box/releases/download/$VERSION/sing-box-$VERSION-linux-amd64.tar.gz
        tar -xzf singbox.tar.gz
        sudo mv sing-box-*/sing-box /usr/local/bin/sing-box
        sudo chmod +x /usr/local/bin/sing-box

    - name: Download proxy list
      run: |
        curl -L -o proxies.txt \
        https://raw.githubusercontent.com/ebrasha/free-v2ray-public-list/refs/heads/main/all_extracted_configs.txt

    - name: Extract random proxy
      run: |
        grep -Eo '(vmess|vless|ss|trojan|hy2)://[^ ]+' proxies.txt | shuf -n 1 > random_proxy.txt
        echo "Random proxy:"
        cat random_proxy.txt

    - name: Convert proxy to sing-box config
      run: |
        sing-box generate -u "$(cat random_proxy.txt)" > config.json
        echo "Generated config.json:"
        cat config.json

    - name: Start sing-box proxy
      run: |
        sing-box run -c config.json &
        sleep 5

    - name: Print IP through proxy
      run: |
        echo "IP through proxy:"
        curl --socks5 127.0.0.1:1080 https://api.ipify.org
